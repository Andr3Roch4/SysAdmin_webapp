# Python Django
# Test a Django project on multiple versions of Python.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
  - main  # Trigger on push to 'main' branch

pr:
  branches:
    include:
      - production  # Trigger on PR to 'production' branch

pool:
  name: Local

jobs:
# Job 1: Runs on push to 'main' branch
- job: PushToMain
  displayName: 'Job triggered by push to main'
  steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: 3.12
        architecture: 'x64'

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install prerequisites'

    - script: |
        python -m pip install flake8
        flake8 ./api
      displayName: 'Run Python lint'
      continueOnError: false

# Job 2: Runs on PR to 'production' branch
- job: PullRequestToProduction
  displayName: 'Job triggered by PR to production'
  condition: eq(variables['Build.SourceBranchName'], 'refs/pull/*')  # Ensures this job only runs for PRs
  steps:
    - script: |
        RESPONSE=$(curl --write-out "%{http_code}" --silent --output /dev/null http://apigrupo3.westeurope.azurecontainer.io:8000/api/produto)
        if [[ "$RESPONSE" -ge 200 && "$RESPONSE" -lt 300 ]]; then
          echo "Request succeeded with status code $RESPONSE."
        else
          echo "Request failed with status code $RESPONSE."
          exit 1  # This will stop the pipeline if the status code is not 200-299
        fi
      displayName: 'Acceptance test'
      continueOnError: false

